# Задание 1

import json

def create_purchases_dict(file_path):
    """
    Читает JSON-строки из файла и создает словарь {user_id: category}
    """
    purchases = {}
    
    try:
        with open(file_path, 'r', encoding='utf-8') as file:
            for line in file:
                # Пропускаем пустые строки
                if not line.strip():
                    continue
                    
                try:
                    # Парсим JSON строку
                    data = json.loads(line.strip())
                    
                    # Проверяем, что это не заголовок
                    if data.get('user_id') == 'user_id':
                        continue
                        
                    user_id = data.get('user_id')
                    category = data.get('category')
                    
                    # Добавляем в словарь, если оба поля существуют
                    if user_id and category:
                        purchases[user_id] = category
                        
                except json.JSONDecodeError as e:
                    print(f"Ошибка при парсинге строки: {line[:50]}... - {e}")
                    continue
                    
    except FileNotFoundError:
        print(f"Файл {file_path} не найден")
        return {}
    
    return purchases

# Основной код
if __name__ == "__main__":
    # Создаем словарь из файла
    purchases = create_purchases_dict("purchase_log.txt")
    
    # Выводим информацию о созданном словаре
    print(f"Создан словарь с {len(purchases)} записями")
    
    # Пример вывода первых 5 записей
    print("\nПример первых 5 записей:")
    for i, (user_id, category) in enumerate(list(purchases.items())[:5]):
        print(f"{user_id}: {category}")
    
    # Или сохраняем результат в файл (опционально)
    with open('purchases_dict.json', 'w', encoding='utf-8') as f:
        json.dump(purchases, f, ensure_ascii=False, indent=2)



# Задание 2

import json

# Шаг 1: Создаем словарь с данными о покупках из purchase_log.txt
purchase_dict = {}

with open('purchase_log.txt', 'r', encoding='utf-8') as f:
    for line in f:
        data = json.loads(line.strip())
        user_id = data.get('user_id')
        category = data.get('category')
        if user_id and category:
            purchase_dict[user_id] = category

# Шаг 2: Обрабатываем visit_log.csv построчно и записываем результаты в funnel.csv
with open('visit_log.csv', 'r', encoding='utf-8') as visits, \
     open('funnel.csv', 'w', encoding='utf-8') as output:
    
    # Записываем заголовок
    output.write('user_id,source,category\n')
    
    # Пропускаем заголовок в visit_log.csv
    visits.readline()
    
    # Обрабатываем каждую строку
    for line in visits:
        line = line.strip()
        if not line:
            continue
            
        # Разделяем строку на user_id и source
        parts = line.split(',')
        if len(parts) >= 2:
            user_id = parts[0].strip()
            source = parts[1].strip()
            
            # Проверяем, есть ли покупка для этого user_id
            if user_id in purchase_dict:
                category = purchase_dict[user_id]
                # Записываем строку в funnel.csv
                output.write(f'{user_id},{source},{category}\n')
    print(f"\nСловарь также сохранен в файл purchases_dict.json")
